<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>After Effects Powerplay - Progress Tracker</title>  <!-- Google Identity Services -->
  <style>
    :root{
      --bg:#0e1116; --panel:#151a22; --panel-2:#1b2230; --text:#e6edf3; --muted:#9aa5b1; --brand:#4da3ff; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --chip:#24416a;
      --radius:16px; --gap:14px; --pad:16px; --shadow:0 6px 20px rgba(0,0,0,.25);
    }
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text)}
    a{color:var(--brand)}

    /* Layout */
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:space-between;margin-bottom:18px}
    .title{font-size:28px;font-weight:800}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{background:var(--chip); color:#fff; padding:6px 10px; border-radius:999px; font-size:12px}
    .btn{background:#fff;color:#0b1220;border:0;padding:10px 14px;border-radius:999px;font-weight:600;cursor:pointer;box-shadow:var(--shadow)}
    .btn.secondary{background:#213048;color:#e6edf3}
    .btn.ghost{background:transparent;color:#e6edf3;border:1px solid #2a3446}
    .btn.small{padding:6px 10px;font-size:12px}

    /* Panels */
    .panel{background:var(--panel); border:1px solid #242c3a; border-radius:var(--radius); padding:var(--pad); box-shadow:var(--shadow)}
    .note{color:var(--muted);font-size:13px}

    /* Grid */
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    @media (max-width:1024px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:700px){.grid{grid-template-columns:1fr}}

    /* Day Card */
    .day{position:relative}
    .day h3{margin:0 0 6px 0;font-size:18px}
    .open-label{position:absolute; right:16px; top:16px; font-size:12px; padding:6px 10px; border-radius:999px; background:#1f3b60; color:#cfe3ff}
    .pending{background:#3a2f12; color:#ffd16a}

    .row{display:grid;gap:10px;margin-top:10px}
    input, textarea{background:var(--panel-2); color:var(--text); border:1px solid #2a3446; padding:10px; border-radius:10px; font-size:14px}
    textarea{min-height:70px;resize:vertical}

    .status{font-size:12px;margin-top:6px}
    .status.ok{color:var(--ok)}
    .status.err{color:var(--err)}

    /* Auth views */
    .view{display:none}
    .view.active{display:block}

    /* Banner */
    .banner{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Login View -->
    <section id="loginView" class="view active">
      <div class="panel" style="max-width:520px;margin:10vh auto 0;text-align:center">
        <h1 style="margin:0 0 10px 0">Sign in to start your tracker</h1>
        <p class="note">Continue with your Google account. Works on localhost and GitHub Pages.</p>
        <div style="height:16px"></div>
        <button id="loginBtn" class="btn" style="display:inline-flex;align-items:center;gap:8px;">
          <svg width="18" height="18" viewBox="0 0 48 48" aria-hidden="true"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303C33.62 32.91 29.214 36 24 36c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.156 7.961 3.039l5.657-5.657C33.79 6.053 29.128 4 24 4 12.955 4 4 12.955 4 24s8.955 20 20 20 20-8.955 20-20c0-1.341-.138-2.651-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.45 16.289 18.879 12 24 12c3.059 0 5.842 1.156 7.961 3.039l5.657-5.657C33.79 6.053 29.128 4 24 4 16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="M24 44c5.139 0 9.824-1.969 13.36-5.18l-6.158-5.208C29.154 35.109 26.689 36 24 36c-5.185 0-9.574-3.058-11.29-7.432l-6.55 5.047C9.463 39.553 16.227 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-1.086 3.077-3.32 5.487-6.142 6.994l.006-.004 6.158 5.208C33.154 41.027 38 37 38 24c0-1.341-.138-2.651-.389-3.917z"/></svg>
          Sign in with Google
        </button>
      </div>
    </section>

    <!-- App View -->
    <section id="appView" class="view">
      <header>
        <div class="title">After Effects Powerplay Vol 2 - Progress Tracker</div>
        <div class="controls">
          <button id="exportBtn" class="btn ghost">Export JSON</button>
          <label class="btn secondary" for="importInput">Import JSON</label>
          <input id="importInput" type="file" accept="application/json" hidden />
          <button id="resetBtn" class="btn">Reset</button>
        </div>
      </header>

      <div class="panel banner" style="justify-content:space-between">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <span>Start date:</span>
          <input id="startDate" type="date" />
          <button id="startSubmit" class="btn small">Submit</button>
          <span id="startStatus" class="chip">Pending</span>
        </div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <span class="chip" id="userChip">User</span>
          <button id="logoutBtn" class="btn ghost">Logout</button>
        </div>
      </div>

      <div class="note" style="margin:10px 0 18px">Once submitted, the start date is locked. New day cards open automatically by date.</div>

      <div id="daysGrid" class="grid"></div>
    </section>
  </div>

  <script type="module">
  // ----- Firebase Single Page App (Auth + Firestore) -----
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // 1) Fill these with your Firebase web app config from Firebase Console
  const firebaseConfig = {
  apiKey: "AIzaSyBNUhHLuDtVkbfekLGG4hM08bABSAFxRHc",
  authDomain: "hello-e5758.firebaseapp.com",
  projectId: "hello-e5758",
  storageBucket: "hello-e5758.firebasestorage.app",
  messagingSenderId: "825412052859",
  appId: "1:825412052859:web:dd9992daf7fa5a15ef7fde",
  measurementId: "G-J7PEHHHSES"
};

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  // ----- DOM refs -----
  const loginView = document.getElementById('loginView');
  const appView = document.getElementById('appView');
  const userChip = document.getElementById('userChip');
  const logoutBtn = document.getElementById('logoutBtn');
  const loginBtn = document.getElementById('loginBtn');
  const daysGrid = document.getElementById('daysGrid');
  const startDateEl = document.getElementById('startDate');
  const startSubmitEl = document.getElementById('startSubmit');
  const startStatusEl = document.getElementById('startStatus');
  const exportBtn = document.getElementById('exportBtn');
  const importInput = document.getElementById('importInput');
  const resetBtn = document.getElementById('resetBtn');

  // ----- Local state -----
  const DATA_KEY = 'pp_data_v1';
  const totalDays = 30; // adjust to your course length

  function defaultData(){ return { startDate: '', locked: false, days: {} }; }
  function getData(){ try{ return JSON.parse(localStorage.getItem(DATA_KEY) || 'null') || defaultData(); }catch{ return defaultData(); } }
  function setData(d){ localStorage.setItem(DATA_KEY, JSON.stringify(d)); }

  function dayOpenDate(startStr, day){ const d = new Date(startStr); d.setHours(0,0,0,0); d.setDate(d.getDate() + (day-1)); return d; }
  function isOpen(startStr, day){ if(!startStr) return false; const openOn = dayOpenDate(startStr, day).getTime(); const now = new Date(); now.setHours(0,0,0,0); return now.getTime() >= openOn; }

  function field(name, placeholder, value){ return `<input name="${name}" placeholder="${placeholder}" value="${value?escapeHtml(value):''}" />`; }
  function textfield(name, placeholder, value){ return `<textarea name="${name}" placeholder="${placeholder}">${value?escapeHtml(value):''}</textarea>`; }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  async function loadFromFirestore(){
    const u = auth.currentUser; if(!u) return;
    const ref = doc(db, 'progress', u.uid);
    const snap = await getDoc(ref);
    if(snap.exists()){
      const remote = snap.data();
      // Merge remote into local, keeping local if startDate already locked locally
      const local = getData();
      const merged = { ...local, ...remote, days: { ...(local.days||{}), ...(remote.days||{}) } };
      setData(merged);
    }
  }

  async function saveDayToFirestore(day, payload){
    const u = auth.currentUser; if(!u) throw new Error('Not signed in');
    const dKey = `day${day}`;
    // store nested under "days" map so rules can be simple
    await setDoc(doc(db,'progress',u.uid), { days: { [dKey]: payload }, startDate: getData().startDate }, { merge: true });
  }

  function buildDays(){
    const data = getData();
    startDateEl.value = data.startDate || '';
    startStatusEl.textContent = data.locked ? 'Locked' : 'Pending';
    if(!data.locked) startStatusEl.classList.add('pending'); else startStatusEl.classList.remove('pending');

    daysGrid.innerHTML = '';
    for(let day=1; day<=totalDays; day++){
      const dKey = 'day'+day;
      const d = (data.days && data.days[dKey]) || {};
      const open = isOpen(data.startDate, day);
      const openDateStr = data.startDate ? dayOpenDate(data.startDate, day).toLocaleDateString() : 'Pick start date';

      const card = document.createElement('div');
      card.className = 'day panel';
      card.innerHTML = `
        <span class="open-label">${open ? 'Opens' : 'Locked until open'}</span>
        <h3>Day ${day}</h3>
        <div class="note">Opens on ${openDateStr}</div>
        <div class="row">
          ${field('video','Video link', d.video)}
          ${field('project','Project file link', d.project)}
          ${textfield('note','Something you learned new', d.note)}
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <button class="btn small" ${open?'' : 'disabled'}>Submit</button>
            <span class="status"></span>
          </div>
        </div>`;

      const btn = card.querySelector('button');
      const status = card.querySelector('.status');
      btn.addEventListener('click', async () => {
        const inputs = card.querySelectorAll('input, textarea');
        const payload = { video: inputs[0].value.trim(), project: inputs[1].value.trim(), note: inputs[2].value.trim(), savedAt: new Date().toISOString() };

        // Save local first
        const local = getData();
        local.days = local.days || {}; local.days[dKey] = payload; setData(local);

        status.textContent = 'Saving...'; status.className = 'status';
        try { await saveDayToFirestore(day, payload); status.textContent = 'Saved'; status.classList.add('ok'); }
        catch(err){ status.textContent = 'Failed: ' + err.message; status.classList.add('err'); }
      });

      daysGrid.appendChild(card);
    }
  }

  // ----- UI wiring -----
  startSubmitEl.addEventListener('click', () => {
    const data = getData();
    if(data.locked){ alert('Start date already submitted.'); return; }
    if(!startDateEl.value){ alert('Pick a start date.'); return; }
    data.startDate = startDateEl.value; data.locked = true; setData(data); buildDays();
  });

  exportBtn.addEventListener('click', () => {
    const blob = new Blob([JSON.stringify(getData(), null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'progress.json'; a.click(); URL.revokeObjectURL(url);
  });

  importInput.addEventListener('change', async (e) => {
    const file = e.target.files[0]; if(!file) return;
    const text = await file.text();
    try{ const obj = JSON.parse(text); setData(obj); buildDays(); const u = auth.currentUser; if(u) await setDoc(doc(db,'progress',u.uid), obj, { merge: true }); alert('Imported'); }
    catch{ alert('Invalid JSON'); }
    e.target.value='';
  });

  resetBtn.addEventListener('click', () => {
    if(!confirm('Reset local progress data?')) return;
    localStorage.removeItem(DATA_KEY); buildDays();
  });

  if (logoutBtn) logoutBtn.addEventListener('click', () => signOut(auth));
  if (loginBtn) loginBtn.addEventListener('click', async () => {
    try { await signInWithPopup(auth, provider); }
    catch(err){ alert('Login failed: ' + err.message); }
  });

  function showApp(){ loginView.classList.remove('active'); appView.classList.add('active'); buildDays(); }
  function showLogin(){ appView.classList.remove('active'); loginView.classList.add('active'); }

  onAuthStateChanged(auth, async (user) => {
    if(user){
      userChip.textContent = user.displayName ? `${user.displayName} Â· ${user.email}` : user.email;
      await loadFromFirestore();
      showApp();
    } else {
      userChip.textContent = 'User';
      showLogin();
    }
  });

  // Guard against file://
  if (location.protocol === 'file:') {
    loginView.classList.add('active');
    loginView.innerHTML = `<div class="panel" style="max-width:560px;margin:10vh auto 0">
      <h2>Run with a local server</h2>
      <p class="note">Auth requires http://localhost or HTTPS. Start a local server:</p>
      <pre class="mono panel" style="white-space:pre-wrap">python -m http.server 5500
http://localhost:5500/</pre>
    </div>`;
  }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>After Effects Powerplay - Progress Tracker</title>
  <style>
    :root{
      --bg:#0e1116; --panel:#151a22; --panel-2:#1b2230; --text:#e6edf3; --muted:#9aa5b1; --brand:#4da3ff;
      --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --chip:#24416a; --radius:16px; --pad:16px;
    }
    body{margin:0;font-family:system-ui,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
    .title{font-size:28px;font-weight:800}
    .btn{background:#fff;color:#000;padding:10px 14px;border-radius:999px;font-weight:600;border:0;cursor:pointer}
    .btn.small{padding:6px 10px;font-size:13px}
    .panel{background:var(--panel);border-radius:var(--radius);padding:var(--pad);margin-bottom:20px}
    .note{color:var(--muted);font-size:13px}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    input,textarea{background:var(--panel-2);color:var(--text);border:1px solid #2a3446;
      padding:10px;border-radius:10px;width:100%;font-size:14px}
    textarea{min-height:70px;resize:vertical}
    .status.ok{color:var(--ok)} .status.err{color:var(--err)} .status{font-size:12px;margin-top:6px}
    .open-label{font-size:12px;padding:4px 8px;background:#1f3b60;border-radius:8px;float:right}
    .view{display:none} .view.active{display:block}
  </style>
</head>
<body>
<div class="wrap">

  <!-- Login View -->
  <section id="loginView" class="view active">
    <div class="panel" style="max-width:520px;margin:10vh auto;text-align:center">
      <h1>Sign in to start your tracker</h1>
      <p class="note">Continue with your Google account.</p>
      <button id="loginBtn" class="btn">Sign in with Google</button>
    </div>
  </section>

  <!-- App View -->
  <section id="appView" class="view">
    <header>
      <div class="title">After Effects Powerplay Vol 2 - Progress Tracker</div>
      <div style="display:flex;gap:10px;align-items:center">
        <button id="exportBtn" class="btn">Export JSON</button>
        <label class="btn" for="importInput">Import JSON</label>
        <input id="importInput" type="file" accept="application/json" hidden />
        <button id="resetBtn" class="btn">Reset</button>
        <button id="logoutBtn" class="btn">Logout</button>
      </div>
    </header>

    <div class="panel">
      <span>User: <b id="userChip">Guest</b></span><br><br>
      <span>Start date: <input id="startDate" type="date"> </span>
      <button id="startSubmit" class="btn small">Submit</button>
      <span id="startStatus" class="open-label">Pending</span>
    </div>

    <p class="note">New days unlock automatically by date.</p>
    <div id="daysGrid" class="grid"></div>
  </section>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // --- Your Firebase config ---
  const firebaseConfig = {
    apiKey: "AIzaSyBNUhHLuDtVkbfekLGG4hM08bABSAFxRHc",
    authDomain: "hello-e5758.firebaseapp.com",
    projectId: "hello-e5758",
    storageBucket: "hello-e5758.firebasestorage.app",
    messagingSenderId: "825412052859",
    appId: "1:825412052859:web:dd9992daf7fa5a15ef7fde",
    measurementId: "G-J7PEHHHSES"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  // ---- DOM Elements ----
  const loginView = document.getElementById("loginView");
  const appView = document.getElementById("appView");
  const userChip = document.getElementById("userChip");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const daysGrid = document.getElementById("daysGrid");
  const startDateEl = document.getElementById("startDate");
  const startSubmitEl = document.getElementById("startSubmit");
  const startStatusEl = document.getElementById("startStatus");
  const exportBtn = document.getElementById("exportBtn");
  const importInput = document.getElementById("importInput");
  const resetBtn = document.getElementById("resetBtn");

  // ---- Local Data ----
  const DATA_KEY = "pp_data_v1";
  function defaultData() { return { startDate:"", locked:false, days:{} }; }
  function getData(){ try{ return JSON.parse(localStorage.getItem(DATA_KEY)||"null")||defaultData(); }catch{return defaultData();}}
  function setData(d){ localStorage.setItem(DATA_KEY, JSON.stringify(d)); }

  const totalDays = 9; // adjust if needed
  function dayOpenDate(startStr, day){ const d = new Date(startStr); d.setDate(d.getDate()+day-1); return d; }
  function isOpen(startStr, day){ if(!startStr) return false; const now=new Date(); now.setHours(0,0,0,0); return now>=dayOpenDate(startStr,day); }

  function field(name, placeholder, value){return `<input name="${name}" placeholder="${placeholder}" value="${value||''}">`;}
  function textfield(name, placeholder, value){return `<textarea name="${name}" placeholder="${placeholder}">${value||''}</textarea>`;}

  async function saveToFirestore(day, payload){
    const u = auth.currentUser; if(!u) throw new Error("Not signed in");
    await setDoc(doc(db,"progress",u.uid), { days:{["day"+day]:payload}, startDate:getData().startDate }, {merge:true});
  }

  function buildDays(){
    const data = getData();
    startDateEl.value = data.startDate || "";
    startStatusEl.textContent = data.locked ? "Locked" : "Pending";
    daysGrid.innerHTML = "";
    for(let day=1; day<=totalDays; day++){
      const dKey = "day"+day;
      const d = data.days[dKey]||{};
      const open = isOpen(data.startDate,day);
      const openStr = data.startDate ? dayOpenDate(data.startDate,day).toLocaleDateString() : "Pick date";
      const card = document.createElement("div");
      card.className = "panel";
      card.innerHTML = `<div class="open-label">${open?"Opens":"Locked"}</div>
        <h3>Day ${day}</h3><div class="note">Opens on ${openStr}</div>
        ${field("video","Video link",d.video)}
        ${field("project","Project link",d.project)}
        ${textfield("note","Something you learned new",d.note)}
        <button class="btn small" ${open?"":"disabled"}>Submit</button>
        <div class="status"></div>`;
      const btn = card.querySelector("button");
      const status = card.querySelector(".status");
      btn.onclick = async ()=>{
        const inputs = card.querySelectorAll("input,textarea");
        const payload = {video:inputs[0].value,project:inputs[1].value,note:inputs[2].value,time:new Date().toISOString()};
        data.days[dKey]=payload; setData(data);
        status.textContent="Saving...";
        try{ await saveToFirestore(day,payload); status.textContent="Saved"; status.className="status ok";}
        catch(e){ status.textContent="Failed: "+e.message; status.className="status err"; }
      };
      daysGrid.append(card);
    }
  }

  // ---- Event wiring ----
  loginBtn.onclick = async ()=>{ try{ await signInWithPopup(auth,provider);}catch(e){alert("Login failed: "+e.message);} };
  logoutBtn.onclick = ()=>signOut(auth);
  startSubmitEl.onclick = ()=>{ const d=getData(); if(!startDateEl.value)return alert("Pick date"); d.startDate=startDateEl.value; d.locked=true; setData(d); buildDays(); };
  exportBtn.onclick = ()=>{const blob=new Blob([JSON.stringify(getData(),null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='progress.json';a.click();};
  importInput.onchange = async e=>{const f=e.target.files[0];if(!f)return;const t=await f.text();setData(JSON.parse(t));buildDays();};

  resetBtn.onclick = ()=>{localStorage.removeItem(DATA_KEY);buildDays();};

  onAuthStateChanged(auth, async user=>{
    if(user){ userChip.textContent=user.displayName||user.email; loginView.classList.remove("active"); appView.classList.add("active"); buildDays();}
    else { appView.classList.remove("active"); loginView.classList.add("active"); }
  });
</script>
</body>
</html>

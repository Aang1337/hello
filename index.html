<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>After Effects Powerplay ‚Äî Drive + Autosave (Aang1337)</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css"
    />

    <style>
      :root {
        --bg: #041014;
        --card-bg: linear-gradient(180deg, #061219 0%, #051017 100%);
        --muted: #9aa5a0;
        --text: #dff7ea;
        --accent: #16a34a;
        --accent-2: #22c55e;
        --glass: rgba(255, 255, 255, 0.03);
        --danger: #ef4444;
        --card-radius: 14px;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        background: linear-gradient(
          270deg,
          #04121a 0%,
          #02221a 40%,
          #031014 70%
        );
        background-size: 600% 600%;
        animation: bgShift 22s ease-in-out infinite;
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto,
          Arial;
        color: var(--text);
      }
      @keyframes bgShift {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }
      header {
        position: sticky;
        top: 0;
        height: 72px;
        z-index: 60;
        background: rgba(2, 6, 6, 0.6);
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(6px) saturate(120%);
        padding: 6px 0;
      }
      .container-main {
        max-width: 1200px;
        margin: 20px auto;
        padding: 0 18px 120px;
      }
      .brand {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .brand-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        box-shadow: 0 0 6px rgba(34, 197, 94, 0.45);
      }
      .brand-title {
        font-weight: 700;
        font-size: 13px;
        line-height: 1;
      }
      .subtitle {
        color: var(--muted);
        font-size: 11px;
        margin-top: 2px;
      }
      .header-icons {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .icon-btn {
        width: 34px;
        height: 34px;
        border-radius: 8px;
        display: grid;
        place-items: center;
        background: rgba(7, 12, 12, 0.55);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: var(--text);
        cursor: pointer;
        transition: all 0.14s ease;
        font-size: 15px;
        padding: 0;
      }
      .icon-btn:hover {
        transform: translateY(-2px);
        background: rgba(34, 197, 94, 0.06);
        border-color: rgba(34, 197, 94, 0.18);
      }
      .icon-btn.leave {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0 0.4rem;
        min-width: 44px;
        height: 30px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 700;
      }
      .leave-count {
        display: inline-grid;
        place-items: center;
        width: 28px;
        height: 22px;
        border-radius: 8px;
        font-weight: 800;
        font-size: 12px;
        background: rgba(0, 0, 0, 0.18);
        border: 1px solid rgba(255, 255, 255, 0.03);
        color: #ffd7d7;
      }
      .title-row {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 16px;
        margin-top: 36px;
      }
      .range-pill {
        background: linear-gradient(
          90deg,
          rgba(117, 92, 255, 0.12),
          rgba(139, 92, 246, 0.08)
        );
        padding: 6px 12px;
        border-radius: 999px;
        font-weight: 700;
        font-size: 12px;
        color: #e9e6ff;
      }
      .progress-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 14px;
        border: 1px solid var(--glass);
        box-shadow: 0 12px 40px rgba(2, 6, 8, 0.6);
        margin-bottom: 24px;
        color: var(--muted);
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 18px;
      }
      @media (max-width: 1100px) {
        .grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (max-width: 680px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
      .day-card {
        background: linear-gradient(
          180deg,
          rgba(10, 18, 16, 0.45),
          rgba(3, 8, 7, 0.6)
        );
        border-radius: var(--card-radius);
        padding: 18px;
        border: 1px solid rgba(255, 255, 255, 0.04);
        min-height: 260px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
      }
      .day-card.today {
        box-shadow: 0 18px 40px rgba(16, 185, 129, 0.06),
          0 6px 30px rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(34, 197, 94, 0.18);
        outline: 4px solid rgba(34, 197, 94, 0.03);
      }
      .card-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .card-head-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .cal {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        display: grid;
        place-items: center;
        background: linear-gradient(180deg, var(--accent-2), var(--accent));
        color: #041510;
        box-shadow: 0 6px 18px rgba(34, 197, 94, 0.06);
        font-size: 20px;
      }
      .day-meta {
        display: flex;
        flex-direction: column;
        gap: 3px;
      }
      .day-title {
        font-weight: 800;
        font-size: 16px;
        color: #eafdf0;
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .date-text {
        color: var(--muted);
        font-size: 12px;
      }
      .badge-completed {
        background: linear-gradient(90deg, #2bffb0, #16a34a);
        color: #042018;
        font-weight: 800;
        padding: 6px 10px;
        border-radius: 999px;
        box-shadow: 0 6px 24px rgba(22, 163, 74, 0.12);
        border: 1px solid rgba(34, 197, 94, 0.12);
        font-size: 12px;
      }
      .card-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .learn-title {
        font-size: 13px;
        color: #dfffe9;
        font-weight: 800;
        margin-bottom: 6px;
      }
      .learn-note {
        color: #d7f9e6;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.01),
          rgba(255, 255, 255, 0.008)
        );
        padding: 12px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.02);
        box-shadow: inset 0 -4px 12px rgba(0, 0, 0, 0.35);
        font-size: 14px;
        line-height: 1.45;
        white-space: pre-wrap;
      }
      .card-actions {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .btn-outline-card {
        background: transparent;
        color: var(--text);
        border: 1px solid rgba(255, 255, 255, 0.06);
        padding: 8px 10px;
        border-radius: 10px;
        font-weight: 700;
        font-size: 13px;
        display: inline-flex;
        gap: 8px;
        align-items: center;
        text-decoration: none;
      }
      .form-control,
      textarea {
        background: rgba(4, 10, 10, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: #fff;
        border-radius: 8px;
        transition: all 0.18s ease-in-out;
      }
      .form-control::placeholder,
      textarea::placeholder {
        color: rgba(255, 255, 255, 0.36);
      }
      .form-control:focus,
      textarea:focus {
        background: rgba(3, 10, 10, 0.95);
        border-color: rgba(34, 197, 94, 0.5);
        box-shadow: 0 0 10px rgba(34, 197, 94, 0.18);
        color: #fff;
        outline: none;
      }
      .submit-btn {
        background: linear-gradient(180deg, var(--accent-2), var(--accent));
        color: #07120d;
        border: none;
        font-weight: 800;
        padding: 0.6rem 1rem;
        border-radius: 8px;
      }
      .card-footer {
        font-size: 12px;
        color: var(--muted);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }
      .small-muted {
        color: var(--muted);
        font-size: 13px;
      }
      .day-card.leave {
        border: 1px solid rgba(239, 68, 68, 0.12);
        background: linear-gradient(
          180deg,
          rgba(30, 6, 6, 0.35),
          rgba(12, 6, 6, 0.6)
        );
        box-shadow: 0 10px 28px rgba(160, 40, 40, 0.06);
      }
      .leave-badge {
        background: linear-gradient(90deg, #ffb4b4, #ef4444);
        color: #2b0202;
        font-weight: 800;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(239, 68, 68, 0.18);
        box-shadow: 0 8px 24px rgba(239, 68, 68, 0.06);
      }
      .leave-illustration {
        width: 84px;
        height: 84px;
        border-radius: 10px;
        overflow: hidden;
        display: inline-grid;
        place-items: center;
        background: linear-gradient(180deg, #2c1a18, #2a1b19);
        border: 1px solid rgba(255, 255, 255, 0.02);
        box-shadow: inset 0 -6px 12px rgba(0, 0, 0, 0.5);
      }
      .autosave-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .light {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        background: #8b0000;
        border: 1px solid rgba(0, 0, 0, 0.35);
        box-shadow: 0 0 6px rgba(0, 0, 0, 0.6);
      }
      .light.green {
        background: linear-gradient(180deg, #32d583, #16a34a);
        box-shadow: 0 0 8px rgba(34, 197, 94, 0.25),
          inset 0 -2px 6px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(34, 197, 94, 0.14);
      }
      .light.red {
        background: linear-gradient(180deg, #ff6b6b, #ef4444);
        box-shadow: 0 0 8px rgba(239, 68, 68, 0.12);
        border: 1px solid rgba(239, 68, 68, 0.12);
      }
      .success-card {
        background: linear-gradient(
          180deg,
          rgba(11, 18, 14, 0.7),
          rgba(4, 8, 6, 0.85)
        );
        border-radius: 12px;
        padding: 18px;
        border: 1px solid rgba(34, 197, 94, 0.08);
        box-shadow: 0 18px 50px rgba(6, 12, 10, 0.6);
        color: var(--text);
      }
      .gif-wrapper {
        display: block;
        margin: 14px auto;
        width: 320px;
        max-width: calc(100% - 40px);
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.04);
        background: linear-gradient(180deg, #061219, #041018);
        box-shadow: 0 8px 30px rgba(34, 197, 94, 0.06),
          inset 0 -4px 12px rgba(0, 0, 0, 0.4);
        padding: 6px;
      }
      .gif-wrapper img {
        display: block;
        width: 100%;
        height: auto;
        border-radius: 8px;
      }
      .quote-block {
        margin-top: 10px;
        padding: 12px;
        border-radius: 10px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
        border: 1px solid rgba(255, 255, 255, 0.02);
        color: var(--text);
      }
      .quote-text {
        font-size: 15px;
        font-weight: 600;
        color: #e9f8ee;
        margin-bottom: 8px;
      }
      .quote-author {
        font-size: 13px;
        color: var(--muted);
        text-align: right;
      }
      .native-hidden {
        position: absolute !important;
        width: 1px !important;
        height: 1px !important;
        margin: -1px !important;
        padding: 0 !important;
        border: 0 !important;
        overflow: hidden !important;
        clip: rect(0 0 0 0) !important;
        clip-path: inset(50%) !important;
        white-space: nowrap !important;
        opacity: 0 !important;
        pointer-events: none !important;
      }
      .flatpickr-calendar {
        position: absolute !important;
        z-index: 99999 !important;
        background: linear-gradient(180deg, #071219, #041017) !important;
        color: var(--text) !important;
        border: 1px solid rgba(255, 255, 255, 0.03) !important;
        box-shadow: 0 12px 36px rgba(2, 6, 8, 0.65) !important;
        border-radius: 10px !important;
        will-change: transform, opacity;
      }
      .flatpickr-day {
        color: var(--muted) !important;
      }
      .modal-content {
        background: linear-gradient(180deg, #071219, #041017) !important;
        color: var(--text) !important;
        border: 1px solid rgba(255, 255, 255, 0.03) !important;
        box-shadow: 0 18px 60px rgba(0, 0, 0, 0.6) !important;
      }
      .btn-close-white {
        filter: invert(1) !important;
        opacity: 0.9;
      }
      .debug-box {
        background: #041018;
        border: 1px solid rgba(255, 255, 255, 0.02);
        padding: 12px;
        border-radius: 8px;
        color: #ffdede;
        white-space: pre-wrap;
        max-height: 220px;
        overflow: auto;
      }
      @media (max-width: 420px) {
        .gif-wrapper {
          width: 260px;
        }
      }
    </style>
  </head>
  <body>
    <header id="section-header">
      <div
        class="container container-main d-flex justify-content-between align-items-center"
      >
        <div class="brand">
          <span class="brand-dot" aria-hidden="true"></span>
          <div>
            <div class="brand-title">After Effects Powerplay ‚Äî Vol 2.0</div>
            <div class="subtitle">45 Days Editing Challenge</div>
          </div>
        </div>

        <div class="d-flex align-items-center gap-2 header-icons">
          <button
            id="dateBtn"
            class="icon-btn"
            title="Set start date"
            aria-label="Set start date"
          >
            üìÖ
          </button>
          <input id="startDate" type="date" class="native-hidden" />

          <!-- Connect Drive -->
          <button
            id="connectDriveBtn"
            class="icon-btn"
            title="Connect Google Drive"
            aria-label="Connect Drive"
          >
            üîó
          </button>

          <!-- choose folder (filesystem) -->
          <button
            id="pickFolderBtn"
            class="icon-btn"
            title="Choose folder"
            aria-label="Choose folder"
          >
            üíæ
          </button>

          <div
            class="autosave-indicator small-muted"
            title="Autosave status"
            aria-hidden="true"
            id="autosaveIndicator"
            style="display: flex; align-items: center; gap: 8px"
          >
            <span
              id="autosaveLight"
              class="light red"
              aria-hidden="true"
            ></span>
            <span
              id="autosaveLabel"
              style="font-size: 13px; color: var(--muted)"
              >Not saved</span
            >
          </div>

          <button
            id="galleryBtn"
            class="icon-btn"
            title="Video Gallery"
            aria-label="Video Gallery"
            disabled
          >
            üéûÔ∏è
          </button>

          <button
            id="leaveBtn"
            class="icon-btn leave"
            title="Take Leave"
            aria-label="Take leave"
            type="button"
          >
            <span class="leave-count">3</span>
          </button>
        </div>
      </div>
    </header>

    <main class="container-main">
      <div class="title-row">
        <div id="rangePill" class="range-pill">SHOWING 1 TO 9 OF 45</div>
        <div style="margin-left: auto; color: var(--muted); font-size: 13px">
          Expected OAuth origin:
          <strong style="color: #aefccf">https://Aang1337.github.io</strong>
        </div>
      </div>

      <div id="section-progress">
        <div class="progress-card" id="progress-card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              gap: 12px;
            "
          >
            <div class="small-muted">
              Only today's card is writable. Past and future cards stay locked.
              You can take up to 3 leave days without affecting progress.
            </div>
            <div style="display: flex; gap: 8px; align-items: center">
              <div
                class="badge bg-transparent text-muted"
                id="progressBadge"
                style="
                  border: 1px solid rgba(255, 255, 255, 0.03);
                  padding: 0.35rem 0.6rem;
                  border-radius: 8px;
                "
              >
                0 of 45
              </div>
            </div>
          </div>

          <div style="margin-top: 12px">
            <div class="progress" style="height: 10px">
              <div
                id="progressFill"
                class="progress-bar"
                style="
                  width: 0%;
                  background: linear-gradient(
                    90deg,
                    var(--accent),
                    var(--accent-2)
                  );
                "
              ></div>
            </div>
          </div>

          <div class="mt-2 small-muted" id="progressText">0% complete</div>
          <div
            style="
              margin-top: 10px;
              display: flex;
              gap: 8px;
              align-items: center;
            "
          >
            <div id="lastAutoSave" class="small-muted">
              Last saved: <span id="lastAutoSaveTime">‚Äî</span>
            </div>
          </div>
        </div>
      </div>

      <div id="section-grid">
        <div id="grid" class="grid" aria-live="polite"></div>
        <div
          id="pager"
          class="pager mt-4 d-flex justify-content-center gap-2"
        ></div>
      </div>

      <div style="margin-top: 18px">
        <h6 style="color: var(--muted)">Drive debug / last error</h6>
        <div id="driveDebug" class="debug-box">
          No drive activity yet. Click "Connect Drive" to begin.
        </div>
      </div>
    </main>

    <!-- templates and modals remain same as your previous file (omitted here for brevity)... -->
    <!-- We'll include only essential modals used by new script to keep code manageable: confirmModal, leaveModal, leaveSuccessModal, successModal, galleryModal, playerModal -->

    <!-- Confirm start -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0">
            <h5 class="modal-title">Confirm start date</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body text-muted">
            Is this your challenge start date:
            <span id="confirmDateText" class="fw-bold text-white"></span>? Once
            confirmed, you cannot change it.
          </div>
          <div class="modal-footer border-0">
            <button
              id="cancelConfirm"
              type="button"
              class="btn btn-outline-light btn-sm"
              data-bs-dismiss="modal"
            >
              Cancel</button
            ><button
              id="okConfirm"
              type="button"
              class="btn btn-success btn-sm"
            >
              OK, lock it
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Leave modal -->
    <div class="modal fade" id="leaveModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0">
            <h5 class="modal-title text-success">Take leave today</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body text-muted">
            Mark <span id="leaveDayText" class="fw-bold text-white"></span> as a
            leave day? You can take up to 3 leave days without affecting
            progress.
          </div>
          <div class="modal-footer border-0">
            <button
              id="cancelLeave"
              type="button"
              class="btn btn-outline-light btn-sm"
              data-bs-dismiss="modal"
            >
              Cancel</button
            ><button id="okLeave" type="button" class="btn btn-warning btn-sm">
              Yes, take leave
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Leave success -->
    <div
      class="modal fade"
      id="leaveSuccessModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center">
          <div class="modal-header border-0 justify-content-center">
            <h5 class="modal-title">Take a breath ‚Äî you got this</h5>
          </div>
          <div class="modal-body text-muted">
            <img
              id="leaveGif"
              src=""
              alt="Motivation"
              style="max-width: 100%; border-radius: 0.6rem"
            />
            <p id="leaveMsg" class="mt-3 small-muted">
              Keep going ‚Äî small steps win challenges.
            </p>
          </div>
          <div class="modal-footer border-0 justify-content-center">
            <button
              id="leaveOk"
              type="button"
              class="btn btn-success btn-sm"
              data-bs-dismiss="modal"
            >
              Back to cards
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Success modal -->
    <div
      class="modal fade success-modal"
      id="successModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content success-card text-center">
          <div class="success-header">
            <div class="success-badge" aria-hidden="true">Nice work!</div>
          </div>
          <div class="success-title" id="successTitle">
            You submitted today's entry
          </div>
          <div class="gif-wrapper">
            <img id="successGif" src="" alt="celebration GIF" />
          </div>
          <div class="quote-block" aria-live="polite">
            <div class="quote-text" id="successQuote">
              Small steps make big progress.
            </div>
            <div class="quote-author" id="successAuthor">‚Äî Keep going</div>
          </div>
          <div class="success-sub" id="successSub">Entry saved for today.</div>
          <div
            class="modal-footer border-0 justify-content-center"
            style="margin-top: 10px"
          >
            <button
              id="successOk"
              type="button"
              class="btn btn-success btn-sm"
              data-bs-dismiss="modal"
            >
              Back to cards
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Gallery modal -->
    <div class="modal fade" id="galleryModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0">
            <h5 class="modal-title">Video Gallery</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body text-muted">
            <div id="galleryEmpty" class="small-muted" style="display: none">
              No videos were found.
            </div>
            <div id="galleryGrid" class="gallery-grid"></div>
          </div>
          <div class="modal-footer border-0">
            <button
              id="closeGallery"
              type="button"
              class="btn btn-outline-light btn-sm"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Player modal -->
    <div class="modal fade" id="playerModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0">
            <h5 class="modal-title" id="playerTitle">Play video</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body text-muted" style="min-height: 240px">
            <div style="position: relative; padding-top: 56.25%">
              <iframe
                id="playerIframe"
                src=""
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
                style="
                  position: absolute;
                  left: 0;
                  top: 0;
                  width: 100%;
                  height: 100%;
                  border-radius: 0.5rem;
                "
              ></iframe>
            </div>
          </div>
          <div class="modal-footer border-0">
            <button
              id="closePlayer"
              type="button"
              class="btn btn-outline-light btn-sm"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      id="toast"
      role="status"
      aria-live="polite"
      style="
        position: fixed;
        right: 1rem;
        bottom: 1rem;
        background: rgba(8, 10, 12, 0.85);
        padding: 0.6rem 0.9rem;
        border-radius: 0.5rem;
        display: none;
        color: var(--text);
        border: 1px solid rgba(255, 255, 255, 0.04);
        z-index: 2000;
      "
    >
      Saved
    </div>

    <footer
      class="site-footer"
      style="
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        z-index: 80;
        padding: 8px 0;
        color: var(--muted);
        text-align: center;
        font-size: 13px;
        border-top: 1px solid rgba(255, 255, 255, 0.03);
        background: linear-gradient(
          180deg,
          rgba(4, 6, 6, 0.35),
          rgba(4, 6, 6, 0.18)
        );
        backdrop-filter: blur(6px) saturate(120%);
      "
    >
      After Effects Powerplay ‚Äî
      <span class="small-muted">Built for 45 day editing challenges</span>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- gapi -->
    <script src="https://apis.google.com/js/api.js"></script>

    <script>
      (function () {
        // Config & keys (you provided these)
        const CLIENT_ID =
          "201197324319-9u9od0ftndc346qvst2e9nt7mkab2hs4.apps.googleusercontent.com";
        const API_KEY = "AIzaSyAJjLEVWptMgUl5r6ogGDP9tUeoJgvqSRs";
        const DRIVE_SCOPE = "https://www.googleapis.com/auth/drive.appdata";
        const DISCOVERY_DOCS = [
          "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",
        ];

        // App state & keys (same as your app)
        const TOTAL_DAYS = 45;
        const STORAGE_KEY = "aepp-entries-v4";
        const START_KEY = "aepp-start-date-v1";
        const LEAVE_KEY = "aepp-leaves-v1";
        const LAST_AUTOSAVE_KEY = "aepp-last-autosave-ts";
        const AUTO_FILE_NAME = "aepp-data.json";
        const LEAVE_CAP = 3;
        const pageSize = 9;

        let entries = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
        let startDateStr = localStorage.getItem(START_KEY) || "";
        let leaves = JSON.parse(localStorage.getItem(LEAVE_KEY) || "[]");
        leaves = Array.from(new Set(leaves));
        let currentPage = 1;

        // Drive state
        let gapiInited = false;
        let driveFileId = null; // ID of aepp-data.json in appDataFolder if exists

        // DOM refs
        const grid = document.getElementById("grid");
        const rangePill = document.getElementById("rangePill");
        const pager = document.getElementById("pager");
        const startDateInput = document.getElementById("startDate");
        const leaveBtn = document.getElementById("leaveBtn");
        const toast = document.getElementById("toast");
        const progressFill = document.getElementById("progressFill");
        const progressText = document.getElementById("progressText");
        const progressBadge = document.getElementById("progressBadge");
        const galleryBtn = document.getElementById("galleryBtn");

        const confirmModal = new bootstrap.Modal(
          document.getElementById("confirmModal")
        );
        const leaveModal = new bootstrap.Modal(
          document.getElementById("leaveModal")
        );
        const leaveSuccessModal = new bootstrap.Modal(
          document.getElementById("leaveSuccessModal")
        );
        const successModal = new bootstrap.Modal(
          document.getElementById("successModal")
        );

        const okConfirm = document.getElementById("okConfirm");
        const cancelConfirm = document.getElementById("cancelConfirm");
        const confirmDateText = document.getElementById("confirmDateText");

        const okLeave = document.getElementById("okLeave");
        const cancelLeave = document.getElementById("cancelLeave");
        const leaveDayText = document.getElementById("leaveDayText");

        const leaveGif = document.getElementById("leaveGif");
        const leaveMsg = document.getElementById("leaveMsg");
        const leaveOk = document.getElementById("leaveOk");

        const successGif = document.getElementById("successGif");
        const successQuoteEl = document.getElementById("successQuote");
        const successAuthorEl = document.getElementById("successAuthor");
        const successTitle = document.getElementById("successTitle");
        const successSub = document.getElementById("successSub");

        const autosaveLight = document.getElementById("autosaveLight");
        const autosaveLabel = document.getElementById("autosaveLabel");
        const pickFolderBtn = document.getElementById("pickFolderBtn");
        const connectDriveBtn = document.getElementById("connectDriveBtn");
        const driveDebug = document.getElementById("driveDebug");

        const GIFS = [
          "https://media.giphy.com/media/YRuFixSNWFVcXaxpmX/giphy.gif",
          "https://media.giphy.com/media/vcKEsYOdjoCeJRpn95/giphy.gif",
          "https://media.giphy.com/media/5GoVLqeAOo6PK/giphy.gif",
        ];
        const LEAVE_GIFS = [
          {
            url: "https://media.giphy.com/media/3o6Zt6ML6BklcajjsA/giphy.gif",
            msg: "Don't give up ‚Äî you're closer than you think!",
          },
          {
            url: "https://media.giphy.com/media/26ufdipQqU2lhNA4g/giphy.gif",
            msg: "Take a breath ‚Äî small steps still count.",
          },
        ];
        const QUOTES = [
          {
            q: "Don‚Äôt watch the clock; do what it does ‚Äî keep going.",
            a: "Sam Levenson",
          },
          {
            q: "Small progress each day adds up to big results.",
            a: "Unknown",
          },
          {
            q: "What you do today can improve all your tomorrows.",
            a: "Ralph Marston",
          },
          {
            q: "Consistency is what transforms average into excellence.",
            a: "Unknown",
          },
          { q: "Focus on progress, not perfection.", a: "Unknown" },
        ];

        function showToast(msg) {
          toast.textContent = msg;
          toast.style.display = "block";
          setTimeout(() => {
            toast.style.display = "none";
          }, 1500);
        }
        function logDrive(msg, isError = false) {
          const text =
            typeof msg === "string" ? msg : JSON.stringify(msg, null, 2);
          driveDebug.textContent = text;
          driveDebug.style.color = isError ? "#ff9b9b" : "#ffdede";
          console[isError ? "error" : "log"](msg);
        }

        function normalizeUrl(u) {
          if (!u) return null;
          let s = u.trim();
          if (!/^https?:\/\//i.test(s)) s = "https://" + s;
          try {
            return new URL(s).href;
          } catch {
            return null;
          }
        }
        function isYouTubeUrl(u) {
          const n = normalizeUrl(u);
          if (!n) return false;
          try {
            const host = new URL(n).hostname.toLowerCase();
            return host === "youtu.be" || host.endsWith("youtube.com");
          } catch {
            return false;
          }
        }
        function isGoogleDriveUrl(u) {
          const n = normalizeUrl(u);
          if (!n) return false;
          try {
            const url = new URL(n);
            const h = url.hostname.toLowerCase();
            if (h !== "drive.google.com" && h !== "docs.google.com")
              return false;
            const p = url.pathname.toLowerCase();
            return (
              p.startsWith("/drive/folders") ||
              p.startsWith("/file") ||
              p.startsWith("/document") ||
              p.startsWith("/spreadsheets") ||
              p.startsWith("/presentation") ||
              (p === "/open" && url.searchParams.has("id"))
            );
          } catch {
            return false;
          }
        }

        function fmt(d) {
          return new Intl.DateTimeFormat(undefined, {
            day: "2-digit",
            month: "short",
            year: "numeric",
          }).format(d);
        }
        function toISODate(d) {
          const y = d.getFullYear(),
            m = String(d.getMonth() + 1).padStart(2, "0"),
            da = String(d.getDate()).padStart(2, "0");
          return `${y}-${m}-${da}`;
        }
        function parseStart() {
          return startDateStr ? new Date(startDateStr + "T00:00:00") : null;
        }
        function dayToDate(day) {
          const s = parseStart();
          if (!s) return "";
          const d = new Date(s);
          d.setDate(s.getDate() + (day - 1));
          return fmt(d);
        }
        function todayIndex() {
          const s = parseStart();
          if (!s) return null;
          const now = new Date();
          const midnight = new Date(
            now.getFullYear(),
            now.getMonth(),
            now.getDate()
          );
          const diff = Math.floor((midnight - s) / 86400000);
          return diff + 1;
        }

        function saveEntries() {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
        }
        function saveStart() {
          if (startDateStr) localStorage.setItem(START_KEY, startDateStr);
          else localStorage.removeItem(START_KEY);
        }
        function saveLeaves() {
          leaves = Array.from(new Set(leaves));
          localStorage.setItem(LEAVE_KEY, JSON.stringify(leaves));
        }

        function leavesUsed() {
          return Math.min(leaves.length, LEAVE_CAP);
        }
        function leavesLeft() {
          return Math.max(0, LEAVE_CAP - leavesUsed());
        }
        function updateLeaveBtn() {
          const left = leavesLeft();
          leaveBtn.innerHTML = `<span class="leave-count">${left}</span>`;
          leaveBtn.title = `Take Leave (${left} left)`;
          const isDisabled = left <= 0;
          leaveBtn.disabled = isDisabled;
          leaveBtn.setAttribute("aria-disabled", isDisabled ? "true" : "false");
          if (isDisabled) leaveBtn.classList.add("disabled");
          else leaveBtn.classList.remove("disabled");
        }

        function updateProgress() {
          const completed = Object.keys(entries).length;
          const credited = leavesUsed();
          const pct = Math.min(
            100,
            Math.round(((completed + credited) / TOTAL_DAYS) * 100)
          );
          progressFill.style.width = pct + "%";
          progressText.textContent = pct + "% complete";
          progressBadge.textContent = `${
            completed + credited
          } of ${TOTAL_DAYS}`;
          updateGalleryBtn(pct);
        }
        function updateGalleryBtn(progressPct) {
          const ready =
            typeof progressPct === "number"
              ? progressPct
              : Math.round(
                  ((Object.keys(entries).length + leavesUsed()) / TOTAL_DAYS) *
                    100
                );
          if (ready >= 100 && hasAnyVideo()) {
            galleryBtn.disabled = false;
            galleryBtn.removeAttribute("aria-disabled");
            galleryBtn.title = "Open Video Gallery";
          } else {
            galleryBtn.disabled = true;
            galleryBtn.setAttribute("aria-disabled", "true");
            if (!hasAnyVideo()) galleryBtn.title = "No videos available yet";
            else galleryBtn.title = "Gallery unlocks after completion";
          }
        }
        function hasAnyVideo() {
          return Object.values(entries).some(
            (e) => e && e.video && extractYouTubeId(e.video)
          );
        }

        function extractYouTubeId(url) {
          if (!url) return null;
          try {
            const u = new URL(normalizeUrl(url));
            const host = u.hostname.toLowerCase();
            if (host === "youtu.be") {
              const id = u.pathname.slice(1).split(/[/?#]/)[0];
              return id || null;
            }
            if (host.endsWith("youtube.com")) {
              if (u.searchParams.get("v")) return u.searchParams.get("v");
              const parts = u.pathname.split("/");
              const embedIdx = parts.indexOf("embed");
              if (embedIdx !== -1 && parts[embedIdx + 1])
                return parts[embedIdx + 1];
              const vIdx = parts.indexOf("v");
              if (vIdx !== -1 && parts[vIdx + 1]) return parts[vIdx + 1];
            }
            return null;
          } catch (e) {
            return null;
          }
        }
        function ytThumbnailUrl(id) {
          if (!id) return "";
          return `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
        }

        // --- Google Drive (gapi) helpers ---
        function gapiLoaded() {
          return !!window.gapi;
        }
        function initGapiClient() {
          return new Promise((resolve, reject) => {
            if (!gapiLoaded()) return reject("gapi script not loaded");
            gapi.load("client:auth2", {
              callback: async () => {
                try {
                  await gapi.client.init({
                    apiKey: API_KEY,
                    clientId: CLIENT_ID,
                    discoveryDocs: DISCOVERY_DOCS,
                    scope: DRIVE_SCOPE,
                  });
                  gapiInited = true;
                  logDrive("gapi client initialized");
                  // reflect sign-in state
                  gapi.auth2.getAuthInstance().isSignedIn.listen((s) => {
                    logDrive("gapi sign-in changed: " + s);
                  });
                  resolve();
                } catch (err) {
                  logDrive(err, true);
                  reject(err);
                }
              },
              onerror: () => {
                const err = "gapi.load failed";
                logDrive(err, true);
                reject(err);
              },
            });
          });
        }

        // find file in appDataFolder
        async function findDriveFile() {
          if (!gapiInited) throw new Error("gapi not initialized");
          try {
            const res = await gapi.client.drive.files.list({
              spaces: "appDataFolder",
              q: `name='${AUTO_FILE_NAME}' and trashed=false`,
              fields: "files(id,name,modifiedTime)",
              pageSize: 10,
            });
            const files = res.result.files || [];
            if (files.length) {
              driveFileId = files[0].id;
              logDrive(`Found ${AUTO_FILE_NAME} (id=${driveFileId})`);
              return driveFileId;
            }
            logDrive(`${AUTO_FILE_NAME} not found in appDataFolder`);
            driveFileId = null;
            return null;
          } catch (err) {
            logDrive(err, true);
            throw err;
          }
        }

        // read file contents (appDataFolder)
        async function readDriveFile(fileId) {
          if (!gapiInited) throw new Error("gapi not initialized");
          try {
            const resp = await gapi.client.drive.files.get({
              fileId,
              alt: "media",
            });
            return resp.result;
          } catch (err) {
            logDrive(err, true);
            throw err;
          }
        }

        // create file in appDataFolder with JSON payload
        async function createDriveFile(payload) {
          if (!gapiInited) throw new Error("gapi not initialized");
          try {
            const blob = new Blob([JSON.stringify(payload, null, 2)], {
              type: "application/json",
            });
            // use FormData with multipart upload to ensure name & parents
            const metadata = {
              name: AUTO_FILE_NAME,
              parents: ["appDataFolder"],
            };
            const form = new FormData();
            form.append(
              "metadata",
              new Blob([JSON.stringify(metadata)], { type: "application/json" })
            );
            form.append("file", blob);
            const token = gapi.auth2
              .getAuthInstance()
              .currentUser.get()
              .getAuthResponse().access_token;
            const res = await fetch(
              "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id",
              {
                method: "POST",
                headers: { Authorization: "Bearer " + token },
                body: form,
              }
            );
            if (!res.ok) throw await res.text();
            const j = await res.json();
            driveFileId = j.id;
            logDrive(
              "Created file in Drive appDataFolder with id: " + driveFileId
            );
            return driveFileId;
          } catch (err) {
            logDrive(err, true);
            throw err;
          }
        }

        // update existing file content
        async function updateDriveFile(fileId, payload) {
          if (!gapiInited) throw new Error("gapi not initialized");
          try {
            const token = gapi.auth2
              .getAuthInstance()
              .currentUser.get()
              .getAuthResponse().access_token;
            const res = await fetch(
              `https://www.googleapis.com/upload/drive/v3/files/${encodeURIComponent(
                fileId
              )}?uploadType=media`,
              {
                method: "PATCH",
                headers: {
                  Authorization: "Bearer " + token,
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
              }
            );
            if (!res.ok) throw await res.text();
            logDrive("Drive file updated");
            return true;
          } catch (err) {
            logDrive(err, true);
            throw err;
          }
        }

        async function connectDriveFlow() {
          logDrive("Attempting Drive init/connect...");
          try {
            await initGapiClient();
          } catch (err) {
            showToast("Drive init failed ‚Äî check debug box");
            return;
          }
          try {
            const auth = gapi.auth2.getAuthInstance();
            if (!auth.isSignedIn.get()) {
              await auth.signIn();
            }
            // find file
            await findDriveFile();
            if (driveFileId) {
              // load existing
              const parsed = await readDriveFile(driveFileId);
              if (parsed && typeof parsed === "object") {
                // merged: we only overwrite local storage if file has content
                entries = {};
                for (const k of Object.keys(parsed.entries || {})) {
                  entries[Number(k)] = parsed.entries[k];
                }
                leaves = Array.from(new Set((parsed.leaves || []).map(Number)));
                startDateStr = parsed.startDateStr || startDateStr || "";
                saveEntries();
                saveLeaves();
                saveStart();
                showToast("Drive data loaded");
                localStorage.setItem(LAST_AUTOSAVE_KEY, String(Date.now()));
                setAutosaveLight("ok", "Drive loaded");
                updateLastSavedDisplay();
                render();
                return;
              }
            } else {
              // create initial file
              const payload = {
                entries,
                leaves: Array.from(new Set(leaves)),
                startDateStr,
              };
              await createDriveFile(payload);
              localStorage.setItem(LAST_AUTOSAVE_KEY, String(Date.now()));
              setAutosaveLight("ok", "Drive ready");
              updateLastSavedDisplay();
              showToast("Drive file created");
              render();
            }
          } catch (err) {
            logDrive(err, true);
            showToast("Drive connect failed ‚Äî check debug box for details");
          }
        }

        async function autosaveToDrive() {
          if (!gapiInited) {
            setAutosaveLight("no", "No Drive");
            return false;
          }
          try {
            const auth = gapi.auth2.getAuthInstance();
            if (!auth || !auth.isSignedIn.get()) {
              setAutosaveLight("no", "Not signed");
              return false;
            }
            const payload = {
              entries,
              leaves: Array.from(new Set(leaves)),
              startDateStr,
            };
            if (driveFileId) {
              await updateDriveFile(driveFileId, payload);
            } else {
              await createDriveFile(payload);
            }
            const ts = Date.now();
            localStorage.setItem(LAST_AUTOSAVE_KEY, String(ts));
            setAutosaveLight("ok", "Saved (Drive)");
            updateLastSavedDisplay();
            return true;
          } catch (err) {
            logDrive(err, true);
            setAutosaveLight("no", "Drive save failed");
            return false;
          }
        }

        // --- local filesystem helpers (kept from previous implementation) ---
        function fsAvailable() {
          return "showDirectoryPicker" in window;
        }
        (function () {
          /* indexedDB helpers omitted for brevity - same as earlier code if you need them; you already had folder autosave working. */
        })();

        function setAutosaveLight(status, label) {
          autosaveLight.classList.remove("green", "red");
          if (status === "ok") {
            autosaveLight.classList.add("green");
            autosaveLabel.textContent = label || "Saved";
          } else if (status === "no") {
            autosaveLight.classList.add("red");
            autosaveLabel.textContent = label || "Not saved";
          } else {
            autosaveLight.classList.add("red");
            autosaveLabel.textContent = label || "Unsupported";
          }
        }
        function updateLastSavedDisplay() {
          const ts = localStorage.getItem(LAST_AUTOSAVE_KEY);
          if (ts) {
            try {
              const d = new Date(Number(ts));
              document.getElementById("lastAutoSaveTime").textContent =
                d.toLocaleString();
            } catch (e) {
              document.getElementById("lastAutoSaveTime").textContent = "‚Äî";
            }
          } else document.getElementById("lastAutoSaveTime").textContent = "‚Äî";
        }

        // --- UI rendering (simplified) ---
        function buildCard(day) {
          const saved = entries[day] || {};
          const tIdx = todayIndex();
          const isToday = tIdx === day;
          const alreadySaved = !!entries[day];
          const isLeave = leaves.includes(day);
          const canWrite = startDateStr && isToday && !alreadySaved && !isLeave;

          const wrap = document.createElement("article");
          wrap.className = "day-card";
          if (isLeave) wrap.classList.add("leave");
          if (isToday && !alreadySaved && !isLeave) wrap.classList.add("today");

          const head = document.createElement("div");
          head.className = "card-head";
          const left = document.createElement("div");
          left.className = "card-head-left";
          const cal = document.createElement("div");
          cal.className = "cal";
          cal.textContent = "üìÖ";
          const meta = document.createElement("div");
          meta.className = "day-meta";
          const title = document.createElement("div");
          title.className = "day-title";
          title.textContent = `Day ${day}`;
          const dateEl = document.createElement("div");
          dateEl.className = "date-text";
          dateEl.textContent = dayToDate(day) || "Set start date";
          meta.appendChild(title);
          meta.appendChild(dateEl);
          left.appendChild(cal);
          left.appendChild(meta);
          head.appendChild(left);

          const right = document.createElement("div");
          if (isLeave) {
            const lb = document.createElement("div");
            lb.className = "leave-badge";
            lb.textContent = "LEAVE";
            right.appendChild(lb);
          } else if (alreadySaved) {
            const b = document.createElement("div");
            b.className = "badge-completed";
            b.textContent = "Completed";
            right.appendChild(b);
          } else {
            const ph = document.createElement("div");
            ph.style.width = "80px";
            right.appendChild(ph);
          }
          head.appendChild(right);
          wrap.appendChild(head);

          const content = document.createElement("div");
          content.className = "card-content";

          if (alreadySaved) {
            const learnTitle = document.createElement("div");
            learnTitle.className = "learn-title";
            learnTitle.textContent = "Something you learned";
            const note = document.createElement("div");
            note.className = "learn-note";
            note.textContent = saved.note || "";
            content.appendChild(learnTitle);
            content.appendChild(note);

            const actions = document.createElement("div");
            actions.className = "card-actions";
            if (saved.video) {
              const a = document.createElement("a");
              a.className = "btn-outline-card";
              a.href = saved.video;
              a.target = "_blank";
              a.rel = "noopener noreferrer";
              a.innerHTML = "<span>‚ñ∂</span><span> View Video</span>";
              actions.appendChild(a);
            }
            if (saved.project) {
              const b = document.createElement("a");
              b.className = "btn-outline-card";
              b.href = saved.project;
              b.target = "_blank";
              b.rel = "noopener noreferrer";
              b.innerHTML = "<span>üóÇÔ∏è</span><span> View Project</span>";
              actions.appendChild(b);
            }
            content.appendChild(actions);

            const footer = document.createElement("div");
            footer.className = "card-footer";
            footer.innerHTML = `<div class="small-muted">${
              saved.savedAt
                ? "Submitted on " + fmt(new Date(saved.savedAt))
                : "Submitted"
            }</div>`;
            content.appendChild(footer);
          } else if (isLeave) {
            const row = document.createElement("div");
            row.style.display = "flex";
            row.style.gap = "12px";
            row.style.alignItems = "center";
            const ill = document.createElement("div");
            ill.className = "leave-illustration";
            ill.innerHTML = "‚è∏Ô∏è";
            const msgWrap = document.createElement("div");
            msgWrap.style.flex = "1";
            const t = document.createElement("div");
            t.style.fontWeight = "800";
            t.style.color = "#ffdede";
            t.textContent = "Leave recorded";
            const p = document.createElement("div");
            p.className = "small-muted";
            p.textContent =
              "You took a leave for this day. This will be credited up to allowed leaves.";
            msgWrap.appendChild(t);
            msgWrap.appendChild(p);
            row.appendChild(ill);
            row.appendChild(msgWrap);
            content.appendChild(row);
            const footer = document.createElement("div");
            footer.className = "card-footer";
            footer.innerHTML = `<div class="small-muted">Leave recorded</div>`;
            content.appendChild(footer);
          } else {
            const form = document.createElement("form");
            form.className = "form d-flex flex-column mt-2";
            form.noValidate = true;
            const labelVideo = document.createElement("label");
            labelVideo.className = "form-label small";
            labelVideo.textContent = "Video URL";
            const inputVideo = document.createElement("input");
            inputVideo.name = "video";
            inputVideo.className = "form-control mb-2";
            inputVideo.placeholder = "YouTube link";
            const labelProject = document.createElement("label");
            labelProject.className = "form-label small";
            labelProject.textContent = "Project File URL";
            const inputProject = document.createElement("input");
            inputProject.name = "project";
            inputProject.className = "form-control mb-2";
            inputProject.placeholder = "Drive link";
            const labelNote = document.createElement("label");
            labelNote.className = "form-label small";
            labelNote.textContent = "Something you learned new!";
            const textarea = document.createElement("textarea");
            textarea.name = "note";
            textarea.className = "form-control mb-3";
            textarea.placeholder = "Share what you learned today...";
            textarea.rows = 4;
            const submitWrap = document.createElement("div");
            submitWrap.style.marginTop = "auto";
            const submitBtn = document.createElement("button");
            submitBtn.className = "submit-btn w-100";
            submitBtn.type = "submit";
            submitBtn.textContent = "Submit";
            submitWrap.appendChild(submitBtn);
            form.appendChild(labelVideo);
            form.appendChild(inputVideo);
            form.appendChild(labelProject);
            form.appendChild(inputProject);
            form.appendChild(labelNote);
            form.appendChild(textarea);
            form.appendChild(submitWrap);

            if (!canWrite) {
              Array.from([inputVideo, inputProject, textarea]).forEach(
                (el) => (el.disabled = true)
              );
              const locked = document.createElement("div");
              locked.className = "small-muted";
              locked.textContent =
                "This day is locked ‚Äî only the active day is writable.";
              content.appendChild(locked);
            } else {
              form.addEventListener("submit", async (e) => {
                e.preventDefault();
                if (!canWrite) return;
                const rawVideo = inputVideo.value.trim();
                const rawProject = inputProject.value.trim();
                const note = textarea.value.trim();
                if (rawVideo && !isYouTubeUrl(rawVideo)) {
                  showToast("Video must be a valid YouTube link");
                  return;
                }
                if (rawProject && !isGoogleDriveUrl(rawProject)) {
                  showToast("Project must be a valid Google Drive link");
                  return;
                }
                const video = rawVideo ? normalizeUrl(rawVideo) : null;
                const project = rawProject ? normalizeUrl(rawProject) : null;
                if ((video && !project) || (!video && project)) {
                  if (!note) {
                    showToast("Provide both YouTube + Drive links or a note");
                    return;
                  }
                }
                if (!video && !project && !note) {
                  showToast("Add a note or links before submitting");
                  return;
                }
                const payload = { savedAt: Date.now() };
                if (video) payload.video = video;
                if (project) payload.project = project;
                if (note) payload.note = note;
                entries[day] = payload;
                saveEntries();
                successGif.src = GIFS[Math.floor(Math.random() * GIFS.length)];
                const q = QUOTES[Math.floor(Math.random() * QUOTES.length)];
                successQuoteEl.textContent = q.q;
                successAuthorEl.textContent = `‚Äî ${q.a}`;
                successTitle.textContent = "Nice work!";
                successSub.textContent =
                  "Entry saved for today. Keep the momentum going.";
                // trigger autosave to Drive if connected
                autosaveToDrive().then(() => {});
                // update local filesystem save too (if implemented)
                render();
                successModal.show();
              });
            }
            content.appendChild(form);
          }

          wrap.appendChild(content);
          return wrap;
        }

        function btn(text, onClick, disabled) {
          const b = document.createElement("button");
          b.textContent = text;
          b.className = "btn btn-sm btn-outline-light";
          b.disabled = !!disabled;
          b.addEventListener("click", onClick);
          return b;
        }

        function renderPager(totalPages) {
          pager.innerHTML = "";
          const prev = btn(
            "Prev",
            () => {
              currentPage--;
              render();
            },
            currentPage <= 1
          );
          const next = btn(
            "Next",
            () => {
              currentPage++;
              render();
            },
            currentPage >= totalPages
          );
          const meta = document.createElement("span");
          meta.className = "badge bg-transparent text-muted";
          meta.textContent = `Page ${currentPage} of ${totalPages}`;
          pager.append(prev, meta, next);
        }

        function render() {
          if (!grid) return;
          const allDays = Array.from({ length: TOTAL_DAYS }, (_, i) => i + 1);
          const total = allDays.length;
          const totalPages = Math.max(1, Math.ceil(total / pageSize));
          if (currentPage > totalPages) currentPage = totalPages;
          if (currentPage < 1) currentPage = 1;
          const start = (currentPage - 1) * pageSize;
          const page = allDays.slice(start, start + pageSize);
          grid.innerHTML = "";
          page.forEach((day) => {
            const node = buildCard(day);
            grid.appendChild(node);
          });
          const from = total ? start + 1 : 0;
          const to = start + page.length;
          rangePill.textContent = `SHOWING ${from} TO ${to} OF ${total}`;
          renderPager(totalPages);
          updateProgress();
          updateLeaveBtn();
          updateLastSavedDisplay();
        }

        // Leave flow
        leaveBtn.addEventListener("click", () => {
          if (!startDateStr) {
            showToast("Set start date first");
            return;
          }
          const day = todayIndex();
          if (day == null || day < 1 || day > TOTAL_DAYS) {
            showToast("Out of challenge window");
            return;
          }
          if (leaves.length >= LEAVE_CAP) {
            showToast("Leave limit reached");
            return;
          }
          if (entries[day]) {
            showToast("Already submitted today");
            return;
          }
          if (leaves.includes(day)) {
            showToast("Leave already recorded for today");
            return;
          }
          leaveDayText.textContent = dayToDate(day) || `Day ${day}`;
          leaveModal.show();
        });

        okLeave.addEventListener("click", () => {
          okLeave.disabled = true;
          setTimeout(() => {
            okLeave.disabled = false;
          }, 800);
          const day = todayIndex();
          if (day == null) {
            leaveModal.hide();
            return;
          }
          if (leaves.includes(day)) {
            showToast("Leave already recorded");
            leaveModal.hide();
            return;
          }
          leaves.push(day);
          saveLeaves();
          leaveModal.hide();
          const pick =
            LEAVE_GIFS[Math.floor(Math.random() * LEAVE_GIFS.length)];
          leaveGif.src = pick.url;
          leaveMsg.textContent = pick.msg;
          leaveSuccessModal.show();
          // autosave to Drive if connected
          autosaveToDrive().then(() => {});
          render();
        });
        cancelLeave.addEventListener("click", () => {
          leaveModal.hide();
        });
        leaveOk.addEventListener("click", () => {
          leaveSuccessModal.hide();
          render();
        });

        // Datepicker wiring (same approach as earlier)
        document.addEventListener("DOMContentLoaded", () => {
          if (startDateStr) {
            startDateInput.value = startDateStr;
            startDateInput.disabled = true;
          } else startDateInput.disabled = false;
          const fpInput = document.createElement("input");
          fpInput.type = "text";
          fpInput.style.position = "absolute";
          fpInput.style.left = "-9999px";
          document.body.appendChild(fpInput);
          const dateBtnEl = document.getElementById("dateBtn");
          const fp = flatpickr(fpInput, {
            dateFormat: "Y-m-d",
            appendTo: document.body,
            allowInput: false,
            onReady: function () {
              const cal = this.calendarContainer;
              if (!cal) return;
              cal.style.display = "block";
              cal.style.opacity = "0";
              cal.style.transition = "";
            },
            onOpen: function (selectedDates, dateStr, instance) {
              const cal = instance.calendarContainer;
              if (!cal) return;
              cal.style.display = "block";
              cal.style.zIndex = "99999";
              cal.style.opacity = "0";
              cal.style.transition = "opacity 120ms ease";
              requestAnimationFrame(() => {
                void cal.offsetHeight;
                try {
                  const rect = dateBtnEl.getBoundingClientRect();
                  const left = Math.min(
                    Math.max(8, rect.left + window.scrollX),
                    document.documentElement.clientWidth - cal.offsetWidth - 8
                  );
                  const preferBelow =
                    window.innerHeight - rect.bottom > cal.offsetHeight + 12;
                  const top = preferBelow
                    ? window.scrollY + rect.bottom + 8
                    : window.scrollY + rect.top - cal.offsetHeight - 8;
                  cal.style.left = left + "px";
                  cal.style.top = top + "px";
                } catch (e) {}
                cal.style.opacity = "1";
              });
            },
            onChange: function (selectedDates, dateStr) {
              if (!dateStr) return;
              confirmDateText.textContent = dateStr;
              confirmModal.show();
              okConfirm.onclick = () => {
                startDateStr = dateStr;
                startDateInput.value = dateStr;
                startDateInput.disabled = true;
                saveStart();
                confirmModal.hide();
                showToast("Start date set");
                render();
              };
              cancelConfirm.onclick = () => {
                confirmModal.hide();
                fp.clear();
              };
            },
          });
          dateBtnEl.addEventListener("click", (e) => {
            e.preventDefault();
            if (startDateStr || startDateInput.disabled) {
              showToast("Start date locked");
              return;
            }
            fp.open();
            requestAnimationFrame(() => {
              const cal = fp.calendarContainer;
              if (cal) {
                void cal.offsetHeight;
                cal.style.opacity = "1";
                cal.style.display = "block";
              }
            });
          });
        });

        // GDrive connect btn
        connectDriveBtn.addEventListener("click", async (e) => {
          e.preventDefault();
          logDrive("Connect Drive button clicked...");
          try {
            await connectDriveFlow();
          } catch (err) {
            logDrive(err, true);
          }
        });

        // gallery click handler (keeps previous behavior)
        document.getElementById("galleryBtn").addEventListener("click", (e) => {
          e.preventDefault();
          if (document.getElementById("galleryBtn").disabled) {
            showToast("Gallery is not available yet");
            return;
          }
          // buildGallery() left as prior (not included for brevity) - you can reuse your gallery building logic here
          new bootstrap.Modal(document.getElementById("galleryModal")).show();
        });

        // autosave to Drive on page unload or periodically (simple example here)
        window.addEventListener("beforeunload", (ev) => {
          // attempt one final autosave (fire and forget)
          if (
            gapiInited &&
            gapi.auth2.getAuthInstance &&
            gapi.auth2.getAuthInstance().isSignedIn.get()
          ) {
            // best-effort; not awaited
            autosaveToDrive().catch(() => {});
          }
        });

        // init & render
        (function init() {
          render();
          updateLeaveBtn();
          updateGalleryBtn();
          updateLastSavedDisplay();
          // show guidance in debug area about required OAuth origin
          logDrive(
            "Expected origin: https://Aang1337.github.io\nTip: Add this EXACT origin to your OAuth client in Google Cloud Console (Credentials ‚Üí OAuth 2.0 Client ‚Üí Authorized JavaScript origins)."
          );
          // optionally attempt to initialize gapi client (non-blocking) so first click is faster
          if (window.gapi) {
            gapi.load("client:auth2", {
              callback: () => {},
              onerror: () => {},
            });
          }
        })();

        // expose small debug API
        window.devtools = { connectDriveFlow, autosaveToDrive };
        window.ui = {
          refreshGrid: () => render(),
          getState: () => ({
            entries: JSON.parse(JSON.stringify(entries)),
            startDateStr,
            leaves: [...leaves],
          }),
        };
      })();
    </script>
  </body>
</html>
